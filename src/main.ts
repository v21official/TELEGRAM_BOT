import { NestFactory, Reflector } from '@nestjs/core';
import { AppModule } from './app.module';
import * as TelegramBot from 'node-telegram-bot-api';
import { Telegraf } from 'telegraf';
// const { Markup } = Telegraf;
import { get, post } from './api';
import { CONSTANTS, validateDomain } from './util/constants';

async function bootstrap() {
    const app = await NestFactory.create(AppModule);
    await app.listen(process.env.PORT || 9496);
    console.log(`Application is running on: ${await app.getUrl()}`);

    const bot = new Telegraf(process.env.TOKEN_BOT);
    const botId = process.env.ID_BOT;
    const command: any = {};

    bot.start((ctx) => ctx.reply(CONSTANTS.BOT_INTRO));
    bot.help((ctx) => ctx.reply(CONSTANTS.BOT_INTRO));
    bot.on('photo', (ctx) => ctx.reply('üëç ü§£ ü§Ø ü•≥ ü•∞'));
    bot.hears('hi', (ctx) => ctx.reply('Hi ' + ctx.from.username));

    bot.command('tha_tim', (ctx) => {
        command[ctx.message.from.id] = '';
        return ctx.reply(`‚ù§`);
    });

    bot.command(CONSTANTS.COMMAND.CANCEL, (ctx) => {
        command[ctx.message.from.id] = '';
        return ctx.reply(`Clean!`);
    });

    bot.command(CONSTANTS.COMMAND.MONITOR_ADD, (ctx) => {
        command[ctx.message.from.id] = CONSTANTS.COMMAND.MONITOR_ADD;
        // const inlineKeyboard = Markup.inlineKeyboard([
        //     Markup.callbackButton('üëç', 'like'),
        //     Markup.callbackButton('üëé', 'dislike'),
        // ]).extra();
        return ctx.replyWithMarkdown(`Nh·∫≠p t√™n mi·ªÅn mu·ªën theo d√µi`);
    });

    bot.command(CONSTANTS.COMMAND.WHOIS, (ctx) => {
        command[ctx.message.from.id] = CONSTANTS.COMMAND.WHOIS;
        return ctx.reply(`Nh·∫≠p t√™n mi·ªÅn mu·ªën ki·ªÉm tra`);
    });

    bot.on('text', async (ctx) => {
        const userId = ctx.message.from.id;
        console.log('state', command);

        if (command[userId] == CONSTANTS.COMMAND.WHOIS) {
            const whois = await get(
                `https://whois.inet.vn/api/whois/domainspecify/${ctx.message.text}`,
            );
            if (whois.code == '0') {
                command[userId] = '';
                ctx.reply(
                    `T√™n mi·ªÅn: ${whois.domainName}
Nh√† ƒëƒÉng k√Ω: <code>${whois.registrar}</code>
Ng√†y ƒëƒÉng k√Ω: <code>${whois.creationDate.replace(/-/g, '/')}</code>
Ng√†y h·∫øt h·∫°n: <code>${whois.expirationDate.replace(/-/g, '/')}</code>`,
                    { parse_mode: 'HTML' },
                );
                return;
            }
            ctx.reply('T√™n mi·ªÅn ch∆∞a ƒë∆∞·ª£c ƒëƒÉng k√Ω');
            return;
        }

        if (command[userId] == CONSTANTS.COMMAND.MONITOR_ADD) {
            if (!validateDomain(ctx.message.text)) {
                ctx.reply('T√™n mi·ªÅn sai ƒë·ªãnh d·∫°ng');
                return;
            }
            const data = await post(`http://103.57.222.93:8082/api/service/create_update`, {
                serviceCreateUpdateDtoList: [
                    {
                        name: ctx.message.text,
                        description: '',
                        type: ['HTTP'],
                    },
                ],
            });
            if (data.status == CONSTANTS.STATUS.SUCCESS) {
                command[userId] = '';
                ctx.reply('T√™n mi·ªÅn ƒë√£ ƒë∆∞·ª£c theo d√µi');
            } else {
                ctx.reply(`${data.message}
Th·ª≠ l·∫°i v·ªõi t√™n mi·ªÅn kh√°c`);
            }
            return;
        }

        if (ctx.message.chat.type == 'private') {
            ctx.reply(CONSTANTS.BOT_INTRO);
        }

        console.log('============= on text =============', ctx);
    });

    bot.on('message', async (ctx) => {
        const msg: any = ctx.message;
        if (msg.left_chat_member) {
            if (msg.left_chat_member.id == botId) {
                console.log('Bot da bi xoa khoi group');
                return;
            }
            const memberName = (
                (msg.left_chat_member.first_name ? msg.left_chat_member.first_name : '') +
                ' ' +
                (msg.left_chat_member.last_name ? msg.left_chat_member.last_name : '')
            ).trim();
            ctx.reply(`T·∫°m bi·ªát ${memberName}`);
            return;
        }

        if (msg.new_chat_member) {
            const memberName = (
                (msg.new_chat_member.first_name ? msg.new_chat_member.first_name : '') +
                ' ' +
                (msg.new_chat_member.last_name ? msg.new_chat_member.last_name : '')
            ).trim();
            ctx.reply(`Ch√†o m·ª´ng th√†nh vi√™n m·ªõi: ${memberName}`);
            return;
        }

        console.log('============= on message =============', ctx);
    });

    await bot.launch();

    // const botId = 1851862079;
    // const myToken = process.env.TOKEN_BOT;
    // const bot = new TelegramBot(myToken, { polling: true });
    //
    // // Matches /echo [whatever]
    // bot.onText(/\/echo (.+)/, (msg, match) => {
    //     console.log(match);
    //     const chatId = msg.chat.id;
    //     const whatever = match[1];
    //     bot.sendMessage(chatId, whatever);
    // });
    //
    // bot.onText(/\/monitor_add/, async (msg) => {
    //     bot.sendMessage(msg.chat.id, 'üëç');
    // });
    //
    // // Matches /photo
    // bot.onText(/\/photo/, async (msg) => {
    //     // From file path
    //     const photo = 'http://inet.vn/public/img/banners/email-theo-ten-mien-featured.png';
    //     bot.sendPhoto(msg.chat.id, photo, { caption: "I'm a bot!" });
    // });
    //
    // // Matches /audio
    // bot.onText(/\/audio/, (msg) => {
    //     const url = 'https://upload.wikimedia.org/wikipedia/commons/c/c8/Example.ogg';
    //     bot.sendAudio(msg.chat.id, url);
    // });
    //
    // // Matches /love
    // bot.onText(/\/bot_ask/, (msg) => {
    //     const opts = {
    //         // parse_mode: "HTML",
    //         // reply_to_message_id: msg.message_id,
    //         reply_markup: {
    //             remove_keyboard: true,
    //             resize_keyboard: true,
    //             one_time_keyboard: true,
    //             keyboard: [
    //                 ['Yes, you are the bot of my life ‚ù§'],
    //                 ['No :)', 'still NO but uppercase'],
    //             ],
    //         },
    //     };
    //     bot.sendMessage(msg.chat.id, 'Do you love me?', opts);
    // });
    //
    // bot.onText(/\/tha_tim/, (msg) => {
    //     bot.sendMessage(msg.chat.id, '‚ù§', {
    //         reply_markup: {
    //             remove_keyboard: true,
    //             keyboard: [],
    //         },
    //     });
    // });
    //
    // bot.onText(/\/remove_keyboard/, (msg) => {
    //     bot.sendMessage(msg.chat.id, 'Success! Keyboard removed', {
    //         reply_markup: {
    //             remove_keyboard: true,
    //             keyboard: [],
    //         },
    //     });
    // });
    //
    // bot.onText(/\/send_html/, (msg) => {
    //     bot.sendMessage(
    //         msg.chat.id,
    //         `<a href="fb.com/v21official">open facebook</a>
    // <b>in ƒë·∫≠m</b>
    // <i>in nghi√™ng</i>
    // <code>th·∫ª code</code>
    // th·∫£ tim lu√¥n /tha_tim
    // `,
    //         {
    //             parse_mode: 'HTML',
    //             reply_markup: {
    //                 remove_keyboard: true,
    //                 keyboard: [],
    //             },
    //         },
    //     );
    // });
    //
    // // Matches /editable
    // bot.onText(/\/do_vui/, (msg) => {
    //     const opts = {
    //         reply_markup: {
    //             inline_keyboard: [
    //                 [
    //                     {
    //                         text: 'Xem k·∫øt qu·∫£',
    //                         // we shall check for this value when we listen
    //                         // for "callback_query"
    //                         callback_data: 'viewResult',
    //                     },
    //                 ],
    //             ],
    //         },
    //     };
    //     bot.sendMessage(msg.chat.id, 'ƒêi·ªÅn v√†o ch·ªó tr·ªëng: iNET S_ _ _w_ _ _', opts);
    // });
    //
    // // Handle callback queries
    // bot.on('callback_query', (callbackQuery) => {
    //     // callback_query use with inline_keyboard
    //     const action = callbackQuery.data;
    //     const msg = callbackQuery.message;
    //     const opts = {
    //         chat_id: msg.chat.id,
    //         message_id: msg.message_id,
    //     };
    //     let text;
    //     if (action === 'viewResult') {
    //         bot.editMessageText(
    //             `${msg.text}
    // B·∫•t ng·ªù ch∆∞a haha: iNET Sssswwww`,
    //             opts,
    //         );
    //     }
    // });
    //
    // // Handle receive message
    // bot.on('message', (msg) => {
    //     const chatId = msg.chat.id;
    //     console.log('=========================================================');
    //     console.log(msg);
    //
    //     if (msg.left_chat_member) {
    //         if (msg.left_chat_member.id == botId) {
    //             console.log('Bot da bi xoa khoi group');
    //             return;
    //         }
    //         const memberName = (
    //             (msg.left_chat_member.first_name ? msg.left_chat_member.first_name : '') +
    //             ' ' +
    //             (msg.left_chat_member.last_name ? msg.left_chat_member.last_name : '')
    //         ).trim();
    //         bot.sendMessage(chatId, `T·∫°m bi·ªát ${memberName}`);
    //         return;
    //     }
    //
    //     if (msg.new_chat_member) {
    //         const memberName = (
    //             (msg.new_chat_member.first_name ? msg.new_chat_member.first_name : '') +
    //             ' ' +
    //             (msg.new_chat_member.last_name ? msg.new_chat_member.last_name : '')
    //         ).trim();
    //         bot.sendMessage(chatId, `Ch√†o m·ª´ng th√†nh vi√™n m·ªõi: ${memberName}`);
    //         return;
    //     }
    //
    //     if (msg.text) {
    //         // bot.sendMessage(
    //         //     chatId,
    //         //     `${(
    //         //         (msg.from.first_name ? msg.from.first_name : '') +
    //         //         ' ' +
    //         //         (msg.from.last_name ? msg.from.last_name : '')
    //         //     ).trim()} n√≥i "${msg.text}"`,
    //         // );
    //         return;
    //     }
    // });
    //
    // bot.on('polling_error', (error) => {
    //     console.log(error);
    // });
}
bootstrap();
